const showErrorDialog = (title, text, callback = null) => {
  Swal.fire({
    icon: "error",
    title: title,
    html: text,
    confirmButtonColor: "#d54d51",
  }).then((result) => {
    if (result.value) {
      if (callback && callback instanceof Function) {
        callback();
      }
    }
  });
};

const showWarningDialog = (title, text) => {
  Swal.fire({
    icon: "warning",
    title: title,
    text: text,
    confirmButtonColor: "#d54d51",
  });
};

const showSuccessDialog = (title, text, callback) => {
  Swal.fire({
    icon: "success",
    title: title,
    text: text,
    confirmButtonColor: "#2d2748",
  }).then(() => {
    if (callback && callback instanceof Function) {
      callback();
    }
  });
};

const showAlert = (title, message, type) => {
  console.log(type);

  if (type === "success") {
    console.log("teste");
    showSuccessDialog(title, message, null);
    return;
  }

  Swal.fire({
    icon: type,
    title: title ? title : "Ops...",
    confirmButtonColor: "#d54d51",
    html: message,
  }).then();
};

function showModal(id) {
  resetModal();
  $("#" + id).addClass("is-open");
  setTimeout(function () {
    $(document).one("click", function () {
      dismissModal();
    });
  }, 200);

  $(document).on("click", ".modal-inner", function (e) {
    e.stopPropagation();
  });

  $(document).one("click", ".modal__close", function (e) {
    $(document).trigger("click");
  });

  $(document).one("click", ".modal__close", function (e) {
    $(document).trigger("click");
  });
}

function dismissModal() {
  clearValidation("#loginForm");
  clearValidation("#memberForm");
  $("#modalSignUp-tela1 .wrapper").html("");
  $(".modal.is-open").removeClass("is-open");
}

function clearValidation(formElement) {
  var validator = $(formElement).validate();
  $("[name]", formElement).each(function () {
    $(this).val("");
    $(this).parent().removeClass("filled");
    validator.successList.push(this);
    validator.showErrors();
  });
  validator.resetForm();
  validator.reset();
}

const handleFail = (err) => {
  $("#loading").hide();
  $("#ajax-loading").hide();
  showErrorDialog("Ops...", err.message);
};

const resetModal = () => {
  $("#modalSignUp-tela1").removeClass("is-current");
  $("#modalSignUp-tela2").removeClass("is-current");
  $("#modalSignUp-tela3").removeClass("is-current");
  $("#modalSignUp-tela4").removeClass("is-current");
  $("#modalSignUp-tela5").removeClass("is-current");
  $("#modalPicture").removeClass("is-current");
};

const updateInput = (input, value) => {
  input.val(value.toString().padStart(2, "0"));
  const root = input.closest(".amount");
  value === 0 ? root.addClass("is-null") : root.removeClass("is-null");
};

const updateAmount = (e) => {
  e.stopPropagation();
  e.preventDefault();

  const action = $(e.target).data("action");
  const noZero = $(e.target).data("nozero");
  const root = $(e.target).closest(".amount");
  const amountInput = root.find(".amount__input input[type='text']");
  let amountVal = parseInt(amountInput.val());

  action === "plus"
    ? (amountVal += 1)
    : !!noZero && amountVal - 1 === 0
    ? 1
    : (amountVal -= 1);
  updateInput(amountInput, amountVal);
};

const doLogin = (model) => {
  const id = $("#modalSignUp-tela1 input[type='hidden']").data("id");
  const slug = $("#modalSignUp-tela1 input[type='hidden']").data("slug");
  model.LoginDocument = model.LoginDocument.replace(/\D/g, "");

  $.ajax({
    method: "POST",
    url: window.loginRoute,
    data: model,
    dataType: "json",
  })
    .done((response) => {
      if (!response.success) {
        handleFail(new Error(response.message));
        return false;
      }

      const data = response.data;
      if (data.logged && !data.member) {
        resetModal();
        $("#modalSignUp-tela6").addClass("is-current");
        $("#ajax-loading").hide();
        return false;
      }

      if (data.logged && data.member && !!id && !!slug) {
        window.location.href = `${window.productDetailRoute}/${slug}?pacote=${id}`;
        return false;
      }

      resetModal();
      $("#modalSignUp-tela4").addClass("is-current");
      $("#ajax-loading").hide();
      $("#continueAsAMember").one(
        "click",
        () => (window.location.href = window.homeRoute)
      );
    })
    .fail(handleFail);
  return false;
};

const goToCartWithSubscription = () => {
  const id = $("#modalSignUp-tela1 input[type='hidden']").data("id");
  window.location.href = window.cartWantBeAMemberRoute + "/" + (!!id ? id : "");
  return false;
};

const showRegisterModal = (event) => {
  event.preventDefault();
  event.stopPropagation();
  resetModal();
  showModal("modal-signUp");
  $("#modalSignUp-tela2").addClass("is-current");
  return;
};

const initCarousel = () => {
  $(".homeCarousel").slick({
    dots: true,
    arrows: false,
    autoplay: true,
    autoplaySpeed: 3000,
  });

  $(".llcCarousel").slick({
    dots: true,
    arrows: false,
    autoplay: true,
    autoplaySpeed: 3000,
  });

  $(".productList--slide").slick({
    arrows: false,
    infinite: false,
    slidesToShow: 3,
    slidesToScroll: 3,
    swipe: false,
    responsive: [
      {
        breakpoint: 767,
        settings: {
          arrows: true,
          dots: false,
          slidesToShow: 1,
          slidesToScroll: 1,
          swipe: true,
        },
      },
    ],
  });

  $(".homeSection--maisVendidos").each((i, e) => {
    const total = $(e).find("input[type='hidden']").val();
    if (!!total) {
      $(e)
        .find(".pagination-init")
        .twbsPagination({
          totalPages: total,
          visiblePages: 5,
          initiateStartPageClick: false,
          next: "PrÃ³ximo",
          prev: "Anterior",
          onPageClick: (event, page) => {
            const slick = $(event.target).parent().find(".productList--slide");
            slick.slick("slickGoTo", page * 3 - 1);
          },
        });
    }
  });
};

$.ajaxSetup({
  global: true,
  cache: false,
  beforeSend: function (xhr) {
    xhr.setRequestHeader(
      "RequestVerificationToken",
      $("#RequestVerificationToken").val()
    );
  },
  error: function (jqXHR, textStatus, errorThrown) {},
});

$(document).ready(function ($) {
  $(".call-menu").click(function (event) {
    $("body").toggleClass("is-menuOpen");
    $(this).toggleClass("is-current");
  });

  $("[data-close-menu]").click(function (e) {
    if (e.target !== e.currentTarget) return;

    $("body").removeClass("is-menuOpen");
  });

  initCarousel();

  var SPMaskBehavior = function (val) {
    return val.replace(/\D/g, "").length === 11
      ? "(00) 00000-0000"
      : "(00) 0000-00009";
  };
  const spOptions = {
    onKeyPress: function (val, e, field, options) {
      field.mask(SPMaskBehavior.apply({}, arguments), options);
    },
    autoUnmask: true,
  };

  $(".sp_celphones").mask(SPMaskBehavior, spOptions);
  $(".mask--creditCardExpiresIn").mask("00/00", {
    reverse: true,
    autoUnmask: true,
  });
  $(".mask--creditCardNumber").mask("0000 0000 0000 0000", {
    reverse: true,
    autoUnmask: true,
  });
  $(".mask--creditCardSecurityNumber").mask("0000", {
    reverse: true,
    autoUnmask: true,
  });
  $(".mask--cpf").mask("000.000.000-00", { reverse: true, autoUnmask: true });
  $(".mask--telefone").mask(SPMaskBehavior, spOptions);

  $(".amount").each(function () {
    var input = $(this).find(".amount__input input[type='text']");
    const val = parseInt(input.val());
    updateInput(input, val);
  });

  $(".form__field").each(function () {
    $(this)
      .find("input[type='text'], select, textarea")
      .on("change", function () {
        if ($(this).val() !== "") {
          $(this).parents(".form__field").addClass("filled");
        } else {
          $(this).parents(".form__field").removeClass("filled");
        }
      });
  });

  $(".form__field input[type='text'], select, textarea").each((i, e) => {
    if ($(e).val() !== "") $(e).parents(".form__field").addClass("filled");
  });

  $gallery = $(".gallerySlider").slick({
    fade: true,
    dots: true,
    arrows: true,
  });

  $(".price__radio input").on("change", function () {
    $(".price__radio input").each(function () {
      if ($(this).is(":checked")) {
        $(this).parent().addClass("is-checked");
      } else {
        $(this).parent().removeClass("is-checked");
      }
    });
  });

  if (
    $("#datetime").val() != "" &&
    document.getElementById("datetime") != null
  ) {
    document.getElementById("datetime").type = "datetime-local";
  }

  if ($("#datetime2").val() != "") {
    var $datetime2 = document.getElementById("datetime2");
    if ($datetime2) {
      document.getElementById("datetime2").type = "datetime-local";
    }
  }

  $("#datetime").on("focus", function () {
    this.type = "datetime-local";
  });

  $("#datetime2").on("focus", function () {
    this.type = "datetime-local";
  });

  $("#datetime").on("focusout", function () {
    if ($("#datetime").val() == "") {
      document.getElementById("datetime").type = "text";
    } else {
      document.getElementById("datetime").type = "datetime-local";
    }
  });

  $("#datetime2").on("focusout", function () {
    if ($("#datetime2").val() == "") {
      document.getElementById("datetime2").type = "text";
    } else {
      document.getElementById("datetime2").type = "datetime-local";
    }
  });

  if (window.location.href.includes("#")) {
    $("html, body").animate(
      { scrollTop: $(window.location.hash).offset().top - 50 },
      600
    );
  }
});

$(document).on("click", "[data-js='modal__dissmiss']", function (e) {
  dismissModal();
});

$(document).on("click", ".iframe-wrapper", function (ev) {
  var play = !$(this).hasClass("noplay");

  if (play) {
    ev.preventDefault();
    $(this).addClass("is-playing");
    const videoID = $(this).attr("data-video");

    $(this).append(
      `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoID}?rel=0&modestbranding=1&showinfo=0&autoplay=1" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`
    );
  }
});

$(document).on("click", ".minicart__toggler", function () {
  $(this).parents(".minicart").toggleClass("is-open");
});

$(document).on("click", ".checkoutSuggestion__toggler", function () {
  $(this).parents(".checkoutSuggestion").toggleClass("is-active");
});

$(document).on("click", ".accordion__toggler", function () {
  $(this).parents(".accordion").toggleClass("is-open");
});

$(document).on("click", ".homeSection--local__galeria__thumbs li", function () {
  const idx = $(this).index(".homeSection--local__galeria__thumbs li");
  showModal("modal-gallery");
  $gallery.slick("goTo", idx);
});

$("body").on("click", ".nav-section", function (e) {
  $("html, body").animate(
    {
      scrollTop: $("#" + $(e.target).data("id")).offset().top - 50,
    },
    600
  );
});

$("body").on("click", ".login-modal", function () {
  resetModal();
  showModal("modal-signUp");
  $("#modalSignUp-tela3").addClass("is-current");
});

$("body").on("click", "#postLogin", (e) => {
  e.preventDefault();
  e.stopPropagation();
  const form = $("#loginForm");
  const isValid = form.valid();
  if (isValid) {
    const model = {};
    form.serializeArray().forEach((field) => (model[field.name] = field.value));
    $("#ajax-loading").show();
    doLogin(model);
    form[0].reset();
  }
});

$("body").on("click", "#postMember", (e) => {
  e.preventDefault();
  e.stopPropagation();
  const form = $("#memberForm");
  const isValid = form.valid();
  if (isValid) {
    const model = {};
    form.serializeArray().forEach((e) => (model[e.name] = e.value));

    $("#ajax-loading").show();
    $.ajax({
      method: "POST",
      url: window.registerRoute,
      data: model,
      dataType: "json",
    })
      .done((response) => {
        if (!response.success) {
          showErrorDialog("", response.message);
          return false;
        }
        form[0].reset();
        resetModal();
        $("#modalSignUp-tela5").addClass("is-current");
        $("#continueBuy").on("click", () =>
          doLogin({ LoginDocument: model.DocumentString })
        );
        return false;
      })
      .fail(handleFail);

    $("#ajax-loading").hide();
  }
});

$("body").on("click", "#btnLoginModal", function () {
  resetModal();
  $("#modalSignUp-tela3").addClass("is-current");
});

$("body").on("click", ".lnk-associate", (e) => {
  e.preventDefault();
  e.stopPropagation();
  resetModal();

  const id = $("#modalSignUp-tela1 input[type='hidden']").data("id");
  const slug = $("#modalSignUp-tela1 input[type='hidden']").data("slug");

  $.get(window.isMemberRoute).done((response) => {
    if (response.success) {
      const data = response.data;
      if (!data.logged || (data.logged && !data.member)) {
        if (!data.logged && !!id && !!slug) {
          //showModal("modal-signUp");
          //$("#modalSignUp-tela2").addClass("is-current");
          showRegisterModal(e);
          return;
        }

        return goToCartWithSubscription();
      } else {
        showModal("modal-signUp");
        $("#modalSignUp-tela4").addClass("is-current");
        return false;
      }
    }
  });
});

$("body").on("click", ".buy-click", (event) => {
  event.preventDefault();
  event.stopPropagation();
  const id = $(event.target).data("id");
  const slug = $(event.target).data("slug");

  $.get(window.isMemberRoute).done((response) => {
    if (response.success) {
      const data = response.data;
      if (data.logged) {
        window.location.href = `${window.productDetailRoute}/${slug}?pacote=${id}`;
      } else {
        $("#modalSignUp-tela1 .wrapper").load(
          `${window.modalRoute}/${id}/${slug}`
        );
        resetModal();
        showModal("modal-signUp");
        $("#modalSignUp-tela1").addClass("is-current");
      }
    }
  });
});

$("body").on("click", ".amount-click", updateAmount);

$("body").on("click", ".homeSection--local__address__link", (e) => {
  e.preventDefault();
  e.stopPropagation();
  window.open(
    encodeURI("https://www.google.com/maps/search/" + $(e.target).data("url"))
  );
});

$("body").on("click", "#continueLoginNotMember", goToCartWithSubscription);

$("body").on("click", "#registerFromLogin", (e) => showRegisterModal(e));

// quando clicar no botao
// ver qual data-product
//

(function () {
  var $video = document.getElementById("video-lp-cover");

  if ($video) {
    $video.addEventListener("click", function () {
      $video.setAttribute("controls", "");
      $video.volume = 0.2;
      $video.play();
    });
  }
})();
